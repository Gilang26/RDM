<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Redeem â€” Auto Build Payload</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
<style>
  body{font-family:'Poppins',system-ui,Arial;background:#0e1510;color:#e8f3e9;display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px}
  .card{width:min(680px,96vw);background:#0f1a12;border:1px solid #214a2f;border-radius:12px;padding:18px}
  h2{color:#22c55e;margin:0 0 10px}
  label{font-size:13px;color:#bfe8c2;margin-top:8px;display:block}
  input{width:100%;padding:10px;border-radius:8px;border:1px solid #203820;background:#08110a;color:#fff;margin-top:6px}
  .row{display:flex;gap:8px;margin-top:10px}
  .row button{flex:1;padding:10px;border-radius:8px;border:0;font-weight:700;cursor:pointer}
  .primary{background:linear-gradient(90deg,#22c55e,#16a34a);color:#06110a}
  .muted{background:#233a27;color:#dff6e6}
  pre{background:#07100a;padding:10px;border-radius:8px;border:1px solid #17381f;margin-top:12px;white-space:pre-wrap}
  small{color:#a7d7be}
</style>
</head>
<body>
  <div class="card">
    <h2>ğŸª„ Redeem â€” Auto-Build Payload</h2>

    <label>Connect Wallet</label>
    <div class="row">
      <button id="btnConnect" class="muted">ğŸ”Œ Connect Wallet</button>
      <button id="btnSwitch" class="muted">ğŸ” Switch to Stable (2201)</button>
    </div>
    <div id="status" style="margin-top:8px;color:#cfeede">Wallet: - | Chain: -</div>

    <hr style="border:0;border-top:1px solid #183820;margin:12px 0"/>

    <label>Jumlah (USDT0, decimals = 6)</label>
    <input id="amount" placeholder="contoh: 10" />

    <label>sender32 (bytes32) â€” kosongkan untuk auto build dari wallet</label>
    <input id="sender32" placeholder="0x + 64 hex (Auto jika kosong)" />

    <label>payload (hex) â€” kosongkan untuk auto build</label>
    <input id="payload" placeholder="0x... (Auto jika kosong)" />

    <div class="row">
      <button id="btnAutoBuild" class="primary">ğŸ§© Auto-build sender32 + payload</button>
      <button id="btnFillSample" class="muted">ğŸ“ Fill contoh (10 USDT)</button>
    </div>

    <label>srcEid (origin) â€” default Sepolia: 30101</label>
    <input id="srcEid" value="30101" />

    <label>Executor (utama)</label>
    <input id="executor" value="0xaB329959fE048721CDF7f13a3eB43e4fc549a9de" />

    <label>Fallback (pisah koma)</label>
    <input id="fallback" value="0xcAB8F3ed8528655E0C2fad1C504c6CfEccf50B90,0x362fca37E45fe1096b42021b543f462D49a5C8df" />

    <div class="row">
      <button id="btnRedeem" class="primary">ğŸš€ Send lzReceive()</button>
      <button id="btnPreview" class="muted">ğŸ” Preview params</button>
    </div>

    <pre id="log">log siap...</pre>
    <small>Note: jika executor menolak (revert), coba fallback atau tunggu relayer resmi.</small>
  </div>

<script>
const $ = id => document.getElementById(id);
const log = (m) => { const el=$("log"); el.textContent += (el.textContent ? "\n" : "") + m; el.scrollTop = el.scrollHeight; console.log(m); };

let provider, signer, me;

async function ensureProvider(){
  if(!window.ethereum) throw new Error("MetaMask/Wallet not found");
  if(!provider) provider = new ethers.providers.Web3Provider(window.ethereum,"any");
}

function addrTo32(a){
  // returns 0x + 64 hex
  const c = ethers.utils.getAddress(a);
  return "0x" + c.slice(2).padStart(64,"0");
}

async function connect(){
  try{
    await ensureProvider();
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    me = await signer.getAddress();
    const net = await provider.getNetwork();
    $("status").textContent = `Wallet: ${me} | Chain: ${net.chainId}`;
    log(`âœ… Connected: ${me} (chain ${net.chainId})`);
  }catch(e){ log("âŒ Connect error: " + (e.message || e)); }
}

async function switchStable(){
  try{
    await ensureProvider();
    await window.ethereum.request({ method:"wallet_switchEthereumChain", params:[{ chainId:"0x899" }] });
    log("ğŸ” Switched to Stable (2201)");
  }catch(e){
    if(e.code === 4902){
      await window.ethereum.request({ method:"wallet_addEthereumChain", params:[{
        chainId:"0x899", chainName:"Stable Testnet",
        rpcUrls:["https://stable-jsonrpc.testnet.chain0.dev"],
        blockExplorerUrls:["https://blockscout.testnet.stable.xyz"],
        nativeCurrency:{ name:"ETH", symbol:"ETH", decimals:18 }
      }]});
      log("â• Added & switched to Stable");
    } else { log("âš ï¸ Switch error: " + (e.message||e)); }
  }
}

async function autoBuildPayload(){
  try{
    if(!signer) await connect();
    const amt = $("amount").value.trim();
    if(!amt) return log("âš ï¸ Masukkan jumlah (ex: 10).");
    // parseUnits with decimals 6
    const amountLD = ethers.utils.parseUnits(amt, 6);
    const to = me;
    const sender32 = addrTo32(me);
    const payload = ethers.utils.defaultAbiCoder.encode(["address","uint256"], [ethers.utils.getAddress(to), amountLD]);
    $("sender32").value = sender32;
    $("payload").value = payload;
    log("ğŸ§© Auto-build sukses:");
    log("sender32: " + sender32);
    log("payload: " + payload);
    log("amountLD: " + amountLD.toString());
  }catch(e){
    log("âŒ Auto-build error: " + (e.message || e));
  }
}

function fillSample10(){
  $("amount").value = "10";
  // do not auto build until button pressed
  log("ğŸ“ Sample 10 USDT filled. Tekan Auto-build untuk buat payload.");
}

function normalizeExecutors(){
  const main = $("executor").value.trim();
  const fb = $("fallback").value.trim();
  const arr = [];
  if(main) arr.push(main);
  if(fb) arr.push(...fb.split(",").map(s=>s.trim()).filter(Boolean));
  // checksum normalize
  const out = [];
  for(const a of arr){
    try{ out.push(ethers.utils.getAddress(a)); }catch{}
  }
  return out;
}

async function previewParams(){
  try{
    const srcEid = Number($("srcEid").value.trim() || 30101);
    const sender32 = $("sender32").value.trim();
    const payload = $("payload").value.trim();
    const exs = normalizeExecutors();
    log("ğŸ” Preview:");
    log("srcEid: " + srcEid);
    log("sender32: " + (sender32 || "(kosong)"));
    log("payload: " + (payload ? payload.slice(0,66)+"..." : "(kosong)"));
    log("executors: " + JSON.stringify(exs));
  }catch(e){ log("âŒ Preview error: " + (e.message||e)); }
}

async function sendRedeem(){
  try{
    if(!signer) await connect();
    const net = await provider.getNetwork();
    if(net.chainId !== 2201){
      log("ğŸ” Mengalihkan ke Stable (2201)...");
      await switchStable();
    }
    const srcEid = Number($("srcEid").value.trim() || 30101);
    let sender32 = $("sender32").value.trim();
    let payload = $("payload").value.trim();

    if(!sender32 || !payload){
      log("âš ï¸ sender32 atau payload kosong â€” mencoba auto-build (pakai wallet & amount)...");
      await autoBuildPayload();
      sender32 = $("sender32").value.trim();
      payload = $("payload").value.trim();
      if(!sender32 || !payload) return log("âŒ Gagal auto-build payload.");
    }

    const executors = normalizeExecutors();
    if(!executors.length) return log("âš ï¸ Executor tidak terisi.");
    // try each executor until success
    for(const ex of executors){
      try{
        log(`ğŸš€ Mencoba lzReceive() via ${ex} ...`);
        const c = new ethers.Contract(ex, ["function lzReceive(uint32,bytes32,bytes,address) external"], signer);
        const tx = await c.lzReceive(srcEid, sender32, payload, ex, { gasLimit: 800000 });
        log("â³ TX: " + tx.hash);
        const rc = await tx.wait();
        log("âœ… Redeem success @ block " + rc.blockNumber + " via " + ex);
        return;
      }catch(e){
        log(`âš ï¸ Executor fail @ ${ex}: ${e.data?.message || e.message || e}`);
      }
    }
    log("âŒ Semua executor gagal. Mungkin kontrak hanya menerima relayer resmi atau payload belum deliverable.");
  }catch(e){
    log("âŒ Redeem error: " + (e.data?.message || e.message || e));
  }
}

// bind
$("btnConnect").onclick = connect;
$("btnSwitch").onclick  = switchStable;
$("btnAutoBuild").onclick = autoBuildPayload;
$("btnFillSample").onclick = fillSample10;
$("btnPreview").onclick = previewParams;
$("btnRedeem").onclick = sendRedeem;
</script>
</body>
</html>
