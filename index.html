<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ğŸª„ LayerZero Manual Redeem â€” Final</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
<style>
  :root{--bg:#0d1511;--card:#111c13;--mut:#214a2f;--fld:#0c1810;--ok1:#22c55e;--ok2:#16a34a;--txt:#e8f3ea;--mutxt:#a7d7be}
  *{box-sizing:border-box}
  body{margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;background:radial-gradient(circle at 20% -20%,#121c16,#0b130e 60%);font-family:Poppins,system-ui,Arial;color:var(--txt);padding:24px}
  .card{width:min(520px,96vw);background:var(--card);border:1px solid var(--mut);border-radius:14px;padding:20px;box-shadow:0 10px 26px rgba(0,0,0,.45)}
  h2{margin:0 0 10px;color:var(--ok1);text-align:center}
  label{font-size:12px;color:var(--mutxt);margin-top:8px;display:block}
  input{width:100%;padding:12px;margin-top:6px;border-radius:10px;border:1px solid var(--mut);background:var(--fld);color:#fff;font-size:14px}
  button{width:100%;padding:12px;margin-top:10px;border:0;border-radius:10px;font-weight:700;cursor:pointer;background:linear-gradient(90deg,var(--ok1),var(--ok2));color:#06110a}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .row > *{flex:1}
  pre{white-space:pre-wrap;background:#0f1a12;border:1px solid var(--mut);border-radius:10px;padding:12px;margin-top:14px;font-size:13px;color:#c9f3dc;min-height:110px}
  .hint{font-size:12px;color:var(--mutxt);margin-top:6px}
  details{margin-top:8px;border:1px dashed var(--mut);border-radius:10px;padding:8px}
  summary{cursor:pointer;color:#cfeede;font-weight:600}
</style>
</head>
<body>
  <div class="card">
    <h2>ğŸª„ LayerZero Manual Redeem</h2>

    <div class="row">
      <button id="btnConnect" style="background:#223a23;color:#cfeede">ğŸ”Œ Connect Wallet</button>
      <button id="btnRedeem">ğŸš€ Redeem Sekarang</button>
    </div>
    <div id="status" class="hint">Wallet: - | Chain: -</div>

    <label>TX Hash (Bridge dari Sepolia)</label>
    <input id="txhash" placeholder="0x... (64 hex)" />

    <details>
      <summary>Advanced (opsional)</summary>
      <div class="row">
        <div>
          <label>srcEid (default 30101 â€” Sepolia)</label>
          <input id="srcEid" value="30101"/>
        </div>
        <div>
          <label>Executor (utama)</label>
          <input id="executor" value="0xaB329959fE048721CDF7f13a3eB43e4fc549a9de"/>
        </div>
      </div>
      <label>Fallback executors (pisah koma)</label>
      <input id="fallback" value="0xcAB8F3ed8528655E0C2fad1C504c6CfEccf50B90"/>
      <label>sender32 (override manual, opsional)</label>
      <input id="sender32" placeholder="0x + 64 hex (biarkan kosong untuk auto)"/>
      <label>payload (override manual, opsional)</label>
      <input id="payload" placeholder="0x... (biarkan kosong untuk auto)"/>
    </details>

    <pre id="log">log siap...</pre>
  </div>

<script>
const CFG = {
  STABLE: { id: 2201, hex: "0x899" },
  SRC_EID_DEFAULT: 30101,
  EXECUTORS_DEFAULT: [
    "0xaB329959fE048721CDF7f13a3eB43e4fc549a9de", // pernah sukses
    "0xcAB8F3ed8528655E0C2fad1C504c6CfEccf50B90"  // wrapper (fallback)
  ]
};
const LZ_ABI = ["function lzReceive(uint32,bytes32,bytes,address) external"];

let provider, signer, me;

const $ = id => document.getElementById(id);
const log = m => { const el=$("log"); el.textContent += (el.textContent? "\n":"") + m; el.scrollTop = el.scrollHeight; console.log(m); };

async function ensureProvider(){
  if (!window.ethereum) throw new Error("Wallet tidak ditemukan (MetaMask/OKX/Trust).");
  if (!provider) provider = new ethers.providers.Web3Provider(window.ethereum, "any");
}

async function switchStable(){
  try{
    await window.ethereum.request({ method:"wallet_switchEthereumChain", params:[{ chainId: CFG.STABLE.hex }] });
  }catch(e){
    if(e.code===4902){
      await window.ethereum.request({ method:"wallet_addEthereumChain", params:[{
        chainId: CFG.STABLE.hex, chainName:"Stable Testnet",
        rpcUrls:["https://stable-jsonrpc.testnet.chain0.dev"],
        blockExplorerUrls:["https://blockscout.testnet.stable.xyz"],
        nativeCurrency:{ name:"ETH", symbol:"ETH", decimals:18 }
      }]} );
    } else { throw e; }
  }
}

async function connect(){
  try{
    await ensureProvider();
    await provider.send("eth_requestAccounts",[]);
    signer = provider.getSigner();
    me = await signer.getAddress();
    const net = await provider.getNetwork();
    if (net.chainId !== CFG.STABLE.id){ await switchStable(); }
    const n2 = await provider.getNetwork();
    $("status").textContent = `Wallet: ${me.slice(0,6)}â€¦${me.slice(-4)} | Chain: ${n2.chainId}`;
    log(`âœ… Connected: ${me}\nChain: ${n2.chainId}`);
  }catch(e){ log("âŒ Connect error: "+(e.message||e)); }
}

function addrTo32(a){ const c=ethers.utils.getAddress(a); return "0x"+c.slice(2).padStart(64,"0"); }

function extractFromText(html){
  const hexes = (html.match(/0x[0-9a-fA-F]{64,}/g) || []);
  const uniq = [...new Set(hexes)];
  const out = { sender32:null, payload:null };
  const senders = uniq.filter(h => h.length===66);
  if (senders.length) out.sender32 = senders[0];
  const payloads = uniq.filter(h => h.length>66 && h.length%2===0);
  if (payloads.length) out.payload = payloads[0];
  return out;
}

async function fetchLayerZero(tx){
  // coba JSON â†’ fallback HTML
  const urls = [
    `https://api.testnet.layerzeroscan.com/tx/${tx}`,
    `https://testnet.layerzeroscan.com/tx/${tx}`,
    `https://api-testnet.layerzeroscan.com/tx/${tx}`
  ];
  for(const u of urls){
    try{
      const r = await fetch(u,{mode:"cors"});
      if(!r.ok) continue;
      const text = await r.text();
      const res = extractFromText(text);
      if(res.sender32 || res.payload) return res;
    }catch{}
  }
  return { sender32:null, payload:null };
}

function normalizeExecutors(){
  const list = [];
  const main = $("executor").value.trim();
  const fb = $("fallback").value.trim();
  if (main) list.push(main);
  if (fb) list.push(...fb.split(",").map(s=>s.trim()).filter(Boolean));
  if (!list.length) list.push(...CFG.EXECUTORS_DEFAULT);
  // checksum & dedup
  const out = [];
  for(const e of list){
    try{
      const ce = ethers.utils.getAddress(e);
      if(!out.includes(ce)) out.push(ce);
    }catch{}
  }
  return out.length ? out : CFG.EXECUTORS_DEFAULT;
}

async function redeem(){
  try{
    if(!signer) await connect();

    // ensure stable
    const net = await provider.getNetwork();
    if (net.chainId !== CFG.STABLE.id){ log("ğŸ” Switch ke Stable..."); await switchStable(); }

    const tx = $("txhash").value.trim();
    if(!/^0x[0-9a-fA-F]{64}$/.test(tx)) return log("âš ï¸ TX hash tidak valid.");

    const srcEid = Number(($("srcEid").value.trim() || CFG.SRC_EID_DEFAULT));

    // ambil advance override
    let sender32 = $("sender32").value.trim();
    let payload  = $("payload").value.trim();

    if(!sender32 || !payload){
      log("â³ Fetching LayerZeroScan...");
      const r = await fetchLayerZero(tx);
      if(!sender32 && r.sender32) sender32 = r.sender32;
      if(!payload  && r.payload)  payload  = r.payload;
      if(!r.sender32 || !r.payload) log("âš ï¸ Data belum lengkap dari LZScan (sender/payload).");
    }

    // fallback build (last resort)
    if(!sender32){ sender32 = addrTo32(me); log("ğŸ§© Auto-build sender32 dari wallet."); }
    if(!payload){
      // payload minimal: encode(to, amount) â†’ amount=0 (placeholder)
      const enc = ethers.utils.defaultAbiCoder.encode(["address","uint256"], [me, ethers.constants.Zero]);
      payload = enc;
      log("ğŸ§© Auto-build payload placeholder (to=wallet, amount=0).");
    }

    // log ringkas
    log(`ğŸ‘¤ sender32: ${sender32}`);
    log(`ğŸ“¦ payload: ${payload.slice(0,66)}...`);

    // try multi-executor
    const executors = normalizeExecutors();
    for(const ex of executors){
      try{
        const c = new ethers.Contract(ex, LZ_ABI, signer);
        log(`ğŸš€ lzReceive via ${ex} ...`);
        const txSend = await c.lzReceive(srcEid, sender32, payload, ex, { gasLimit: 700000 });
        log(`â³ TX: ${txSend.hash}`);
        const rc = await txSend.wait();
        log(`âœ… Redeem selesai di block ${rc.blockNumber} (executor: ${ex})`);
        return;
      }catch(e){
        log(`âš ï¸ Executor fail @ ${ex}: ${e.data?.message || e.message || e}`);
      }
    }
    log("âŒ Semua executor gagal. Kemungkinan kontrak membatasi caller (relayer-only) atau payload belum siap.");
  }catch(e){
    log("âŒ Redeem error: " + (e.data?.message || e.message || e));
  }
}

$("btnConnect").onclick = connect;
$("btnRedeem").onclick  = redeem;
</script>
</body>
</html>
