<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TX Inspector (Stable Testnet)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
<style>
body{font-family:Poppins,Arial,sans-serif;background:#0c1410;color:#c9f7d4;
display:flex;flex-direction:column;align-items:center;justify-content:center;
min-height:100vh;margin:0;padding:20px}
.card{background:#101b13;border:1px solid #224a2a;padding:20px;border-radius:14px;width:min(520px,95vw)}
h2{margin-top:0;color:#22c55e;text-align:center}
input,button{width:100%;padding:12px;margin-top:10px;border-radius:8px;font-size:15px}
input{border:1px solid #333;background:#0a120d;color:#fff}
button{background:linear-gradient(90deg,#22c55e,#16a34a);color:#fff;border:0;cursor:pointer;font-weight:700}
small{color:#92e6a5}
pre{background:#0f1912;color:#9ef7ae;padding:12px;border-radius:8px;white-space:pre-wrap;margin-top:14px;max-height:50vh;overflow:auto}
</style>
</head>
<body>
<div class="card">
  <h2>üîç TX Inspector ‚Äî Stable Testnet</h2>
  <label>RPC (boleh kosong, akan pakai fallback list):</label>
  <input id="rpc" placeholder="https://stable-jsonrpc.testnet.chain0.dev" />
  <label>TX Hash</label>
  <input id="txHash" placeholder="0x..." />
  <button id="btnInspect">Inspect</button>
  <small>Tips: kalau timeout, kosongkan RPC agar pakai fallback, lalu klik lagi.</small>
  <pre id="log">log siap...</pre>
</div>

<script>
const $ = id => document.getElementById(id);
const log = m => { const el=$('log'); el.textContent += (el.textContent?'\n':'') + m; el.scrollTop = el.scrollHeight; console.log(m); };

// Daftar RPC fallback (isi yang kamu punya/percaya). Tambah jika ada mirror lain.
const FALLBACK_RPCS = [
  "https://stable-jsonrpc.testnet.chain0.dev",
  // Tambahkan mirror lain di sini jika ada:
  // "https://<mirror-1>",
  // "https://<mirror-2>",
];

function validTx(h){ return /^0x[0-9a-fA-F]{64}$/.test(h); }
const sleep = ms => new Promise(r=>setTimeout(r,ms));

async function getReceiptWithRetry(rpc, tx){
  const provider = new ethers.providers.JsonRpcProvider(rpc, undefined, { timeout: 15000 });
  // 3x retry dengan backoff 1s, 2s, 3s
  for(let i=1;i<=3;i++){
    try{
      const rc = await provider.getTransactionReceipt(tx);
      return rc;
    }catch(e){
      log(`‚ö†Ô∏è [${i}/3] ${rpc} ‚Üí ${e.code||'ERR'}: ${e.message||e}`);
      await sleep(i*1000);
    }
  }
  throw new Error(`Timeout di RPC ${rpc}`);
}

async function inspect(){
  $('log').textContent = '‚è≥ Fetching receipt...';
  const tx = $('txHash').value.trim();
  if(!validTx(tx)) return log('‚ö†Ô∏è TX hash tidak valid');

  // susun list RPC: user ‚Üí fallback
  const userRpc = ($('rpc').value.trim() || '').replace(/\s+/g,'');
  const list = userRpc ? [userRpc, ...FALLBACK_RPCS.filter(r=>r!==userRpc)] : [...FALLBACK_RPCS];

  let receipt=null, used=null, lastErr=null;
  for(const rpc of list){
    log(`üîó Mencoba RPC: ${rpc}`);
    try{
      receipt = await getReceiptWithRetry(rpc, tx);
      used = rpc;
      break;
    }catch(e){ lastErr = e; }
  }
  if(!receipt){
    log(`‚ùå Gagal ambil receipt dari semua RPC. ${lastErr? (lastErr.message||lastErr):''}`);
    return;
  }

  if(!receipt){
    log('‚ùì Receipt belum ditemukan (pending / RPC belum sinkron).');
    return;
  }

  log(`‚úÖ OK dari RPC: ${used}`);
  log(`Block: ${receipt.blockNumber || '-'} | Status: ${receipt.status===1?'SUCCESS':receipt.status===0?'FAILED':receipt.status}`);
  log(`Logs: ${receipt.logs? receipt.logs.length : 0}`);

  const transferSig = ethers.utils.id("Transfer(address,address,uint256)");
  let foundTransfer = false;

  for(const lg of (receipt.logs||[])){
    try{
      if(lg.topics && lg.topics[0] === transferSig){
        const from = ethers.utils.getAddress("0x"+lg.topics[1].slice(26));
        const to   = ethers.utils.getAddress("0x"+lg.topics[2].slice(26));
        const raw  = ethers.BigNumber.from(lg.data);
        log(`\nüí∏ Transfer @ ${lg.address}`);
        log(`from: ${from}`);
        log(`to:   ${to}`);
        log(`amount raw: ${raw.toString()}`);
        try{ log(`amount(6):  ${ethers.utils.formatUnits(raw,6)}`); }catch{}
        try{ log(`amount(18): ${ethers.utils.formatUnits(raw,18)}`); }catch{}
        foundTransfer = true;
      }
    }catch{}
  }

  if(!foundTransfer){
    log('\n‚ÑπÔ∏è Tidak ada event Transfer di TX ini.\nKemungkinan: lzReceive() tidak mint/transfer token, atau mint ke kontrak lain.');
  }
}

$('btnInspect').onclick = inspect;
</script>
</body>
</html>
